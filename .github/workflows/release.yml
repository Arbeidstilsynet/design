name: Release

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        id: app-token
        with:
          app-id: ${{ vars.BETZY_BOT_APP_ID }}
          private-key: ${{ secrets.BETZY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
      - uses: Arbeidstilsynet/action-pnpm-setup@f85980486b86b35f3ad337b60b3b03c36d16e343 # v1

      - uses: changesets/action@v1
        id: changeset
        with:
          version: pnpm run version
          publish: pnpm run release
          commit: "chore(release): ðŸ“¦ version packages"
          title: "chore(release): ðŸ“¦ version packages"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Notify Slack about published packages
        if: steps.changeset.outputs.published == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PUBLISHED_PACKAGES: ${{ steps.changeset.outputs.publishedPackages }}
          CHANNEL_NAME: "#plattform"
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set. Skipping Slack notification."
            exit 0
          fi

          if [ -z "$PUBLISHED_PACKAGES" ]; then
            echo "PUBLISHED_PACKAGES is empty. Skipping Slack notification."
            exit 0
          fi

          # Turn JSON array into a readable bullet list:
          PACKAGES_TEXT=$(echo "$PUBLISHED_PACKAGES" | jq -r 'map("- \(.name) \(.version)") | join("\n")')

          # Build text with a real newline before the first bullet
          TEXT=$(printf 'New versions published to NPM from https://github.com/Arbeidstilsynet/design\n%s' "$PACKAGES_TEXT")

          payload=$(jq -Rn \
            --arg text "$TEXT" \
            --arg channel "$CHANNEL_NAME" \
            '{channel:$channel, text:$text}')

          curl -fsS -X POST --data-urlencode "payload=$payload" "$SLACK_WEBHOOK_URL" || {
            echo "Slack notification failed"
            exit 1
          }
